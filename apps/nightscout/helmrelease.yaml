---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: nightscout
  namespace: nightscout
spec:
  interval: 30m
  chart:
    spec:
      chart: ./
      sourceRef:
        kind: GitRepository
        name: helm-nightscout
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    global:
      imagePullSecrets:
        - dockerhub-pull-secret

    image:
      repository: nightscout/cgm-remote-monitor
      tag: "15.0.3"

    replicaCount: 1

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi

    service:
      type: ClusterIP
      port: 1337

    ingress:
      enabled: true
      className: "istio"
      annotations:
        cert-manager.io/cluster-issuer: "selfsigned-issuer"
      hosts:
        - host: nightscout.homelab.local
          paths:
            - path: /
              pathType: Prefix
      tls:
        - secretName: nightscout-tls
          hosts:
            - nightscout.homelab.local

    networkPolicy:
      enabled: true
      ingress:
        enabled: true
        namespaceSelector:
          matchLabels:
            name: istio-system
      egress:
        enabled: true
        allowExternal: true

    # MongoDB is now integrated into the chart
    # Secrets are auto-generated
    mongodb:
      enabled: true
      image:
        tag: "7.0.6-debian-12-r0"
      auth:
        enabled: true
        database: nightscout
        username: nightscout
        # Password will be auto-generated by the chart
      persistence:
        enabled: true
        size: 8Gi
      resources:
        limits:
          cpu: 500m
          memory: 512Mi
        requests:
          cpu: 250m
          memory: 256Mi

    nightscout:
      # MongoDB URI and API secret will be auto-generated
      # Leave commented to use integrated MongoDB and auto-generated secret

      baseUrl: "https://nightscout.gluk0.sh"

      enable:
        - careportal
        - boluscalc
        - food
        - rawbg
        - iob
        - cob
        - bwp
        - cage
        - sage
        - iage
        - bage
        - basal
        - ar2
        - treatmentnotify

      auth:
        defaultRoles: "readable"

      alarms:
        types: "simple"
